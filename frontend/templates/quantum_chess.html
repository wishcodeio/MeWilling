{% extends "base.html" %}

{% block title %}é‡å­è±¡æ£‹ | å•†å¢éˆæ€§ç³»çµ±{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-blue-900 text-white">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-4 bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">
                â™› é‡å­è±¡æ£‹ â™›
            </h1>
            <p class="text-xl text-gray-300 mb-6">åœ¨é‡å­å åŠ æ€ä¸­ä½“éªŒä¼ ç»Ÿè±¡æ£‹çš„æ— é™å¯èƒ½</p>
            
            <!-- åˆå­¦è€…è¯´æ˜ -->
            <div class="bg-gradient-to-r from-purple-800/30 to-blue-800/30 rounded-lg p-6 mb-8 border border-purple-500/30">
                <h2 class="text-2xl font-semibold mb-4 text-yellow-300">ğŸŒŸ åˆå­¦è€…æŒ‡å—</h2>
                <div class="grid md:grid-cols-2 gap-6 text-left">
                    <div>
                        <h3 class="text-lg font-semibold mb-3 text-blue-300">ğŸ“š é‡å­è±¡æ£‹åŸºç¡€</h3>
                        <ul class="space-y-2 text-gray-300">
                            <li>â€¢ <strong>å åŠ æ€ï¼š</strong>æ£‹å­å¯ä»¥åŒæ—¶å­˜åœ¨äºå¤šä¸ªä½ç½®</li>
                            <li>â€¢ <strong>é‡å­åˆ†è£‚ï¼š</strong>ä¸€æ­¥æ£‹å¯ä»¥åˆ›é€ å¤šç§å¯èƒ½æ€§</li>
                            <li>â€¢ <strong>æµ‹é‡å¡Œç¼©ï¼š</strong>è§‚å¯Ÿæ—¶æ£‹å­ç¡®å®šä½ç½®</li>
                            <li>â€¢ <strong>é‡å­çº ç¼ ï¼š</strong>æ£‹å­é—´å­˜åœ¨ç¥ç§˜å…³è”</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-3 text-green-300">ğŸ¯ æ¸¸æˆç›®æ ‡</h3>
                        <ul class="space-y-2 text-gray-300">
                            <li>â€¢ å°†æ­»å¯¹æ–¹çš„å°†/å¸…</li>
                            <li>â€¢ åˆ©ç”¨é‡å­ç‰¹æ€§åˆ›é€ ä¼˜åŠ¿</li>
                            <li>â€¢ åœ¨ä¸ç¡®å®šæ€§ä¸­å¯»æ‰¾ç¡®å®šæ€§</li>
                            <li>â€¢ ä½“éªŒé‡å­æ€ç»´çš„å¥¥å¦™</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- è±¡æ£‹å£è¯€ -->
            <div class="bg-gradient-to-r from-yellow-800/30 to-orange-800/30 rounded-lg p-6 mb-8 border border-yellow-500/30">
                <h2 class="text-2xl font-semibold mb-4 text-yellow-300">ğŸ“œ é‡å­è±¡æ£‹å£è¯€</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div class="bg-black/20 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-purple-300 mb-2">ğŸŒ€ åˆ†è£‚å¿ƒè¯€</h4>
                            <p class="text-gray-300 italic">"ä¸€å¿ƒäºŒç”¨ï¼Œè™šå®å¹¶å­˜ï¼Œ<br>æœªæµ‹ä¹‹å‰ï¼Œçš†ä¸ºå¯èƒ½"</p>
                        </div>
                        <div class="bg-black/20 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-blue-300 mb-2">ğŸ”„ åˆå¹¶å¿ƒè¯€</h4>
                            <p class="text-gray-300 italic">"ä¸‡æ³•å½’ä¸€ï¼Œæµ‹é‡å®šçœŸï¼Œ<br>é€‰æ‹©å½“ä¸‹ï¼Œå¡Œç¼©æˆå½¢"</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-black/20 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-green-300 mb-2">ğŸŒ çº ç¼ å¿ƒè¯€</h4>
                            <p class="text-gray-300 italic">"å½¼æ­¤ç›¸ä¾ï¼Œå‘½è¿å…±æŒ¯ï¼Œ<br>ä¸€åŠ¨å…¨åŠ¨ï¼Œå› æœç›¸è¿"</p>
                        </div>
                        <div class="bg-black/20 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-red-300 mb-2">âš¡ è§‚æµ‹å¿ƒè¯€</h4>
                            <p class="text-gray-300 italic">"è§‚è€…æ”¹å˜ï¼Œæµ‹è€…å®šå½¢ï¼Œ<br>æ„è¯†ä¹‹åŠ›ï¼Œå¡‘é€ ç°å®"</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¼ ç»Ÿè±¡æ£‹å£è¯€ -->
            <div class="bg-gradient-to-r from-red-800/30 to-pink-800/30 rounded-lg p-6 mb-8 border border-red-500/30">
                <h2 class="text-2xl font-semibold mb-4 text-red-300">ğŸ® ä¼ ç»Ÿè±¡æ£‹å£è¯€</h2>
                <div class="grid md:grid-cols-3 gap-4 text-sm">
                    <div class="bg-black/20 rounded-lg p-3">
                        <h5 class="font-semibold text-yellow-300 mb-2">å¼€å±€è¦è¯€</h5>
                        <p class="text-gray-300">"é©¬èµ°æ—¥ï¼Œè±¡èµ°ç”°ï¼Œ<br>ç‚®æ‰“éš”å±±ï¼Œè½¦èµ°ç›´çº¿"</p>
                    </div>
                    <div class="bg-black/20 rounded-lg p-3">
                        <h5 class="font-semibold text-blue-300 mb-2">ä¸­å±€è¦è¯€</h5>
                        <p class="text-gray-300">"å…µè´µç¥é€Ÿï¼Œé©¬æœ‰å…«é¢å¨é£ï¼Œ<br>ç‚®é•‡ä¸­å®«ï¼Œè½¦æ§è¦é“"</p>
                    </div>
                    <div class="bg-black/20 rounded-lg p-3">
                        <h5 class="font-semibold text-green-300 mb-2">æ®‹å±€è¦è¯€</h5>
                        <p class="text-gray-300">"å’å­è¿‡æ²³ï¼Œèƒœè¿‡ä¹è½¦ï¼Œ<br>é©¬è¸å››æ–¹ï¼Œå°†å¸…éš¾é€ƒ"</p>
                    </div>
                    <div class="bg-black/20 rounded-lg p-3">
                        <h5 class="font-semibold text-purple-300 mb-2">æˆ˜æœ¯è¦è¯€</h5>
                        <p class="text-gray-300">"å¼ƒå­äº‰å…ˆï¼Œèˆè½¦ä¿å¸…ï¼Œ<br>å£°ä¸œå‡»è¥¿ï¼Œæš—åº¦é™ˆä»“"</p>
                    </div>
                    <div class="bg-black/20 rounded-lg p-3">
                        <h5 class="font-semibold text-orange-300 mb-2">å¿ƒæ³•è¦è¯€</h5>
                        <p class="text-gray-300">"é™å¦‚å¤„å­ï¼ŒåŠ¨å¦‚è„±å…”ï¼Œ<br>èƒ¸æœ‰æˆç«¹ï¼Œå¿ƒæ— æ—éª›"</p>
                    </div>
                    <div class="bg-black/20 rounded-lg p-3">
                        <h5 class="font-semibold text-cyan-300 mb-2">åˆ¶èƒœè¦è¯€</h5>
                        <p class="text-gray-300">"æ”»å…¶ä¸å¤‡ï¼Œå‡ºå…¶ä¸æ„ï¼Œ<br>çŸ¥å·±çŸ¥å½¼ï¼Œç™¾æˆ˜ä¸æ®†"</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆæ§åˆ¶é¢æ¿ -->
        <div class="max-w-6xl mx-auto">
            <div class="grid lg:grid-cols-3 gap-8">
                <!-- æ¸¸æˆè®¾ç½® -->
                <div class="lg:col-span-1">
                    <div class="bg-black/30 rounded-lg p-6 border border-purple-500/30">
                        <h3 class="text-xl font-semibold mb-4 text-purple-300">ğŸ® æ¸¸æˆè®¾ç½®</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">æ¸¸æˆæ¨¡å¼</label>
                                <select id="gameMode" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white">
                                    <option value="self">è‡ªæˆ‘å¯¹å¼ˆ</option>
                                    <option value="ai-easy">AIå¯¹æˆ˜(ç®€å•)</option>
                                    <option value="ai-medium">AIå¯¹æˆ˜(ä¸­ç­‰)</option>
                                    <option value="ai-hard">AIå¯¹æˆ˜(å›°éš¾)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">é‡å­æ¨¡å¼</label>
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="quantumMode" checked class="rounded">
                                    <span>å¯ç”¨é‡å­ç‰¹æ€§</span>
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <button id="startGame" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 px-4 py-2 rounded-lg font-semibold transition-all duration-300">
                                    ğŸš€ å¼€å§‹æ¸¸æˆ
                                </button>
                                <button id="resetGame" class="w-full bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 px-4 py-2 rounded-lg font-semibold transition-all duration-300">
                                    ğŸ”„ é‡ç½®æ¸¸æˆ
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- é‡å­æ§åˆ¶ -->
                    <div class="bg-black/30 rounded-lg p-6 border border-blue-500/30 mt-6">
                        <h3 class="text-xl font-semibold mb-4 text-blue-300">âš›ï¸ é‡å­æ§åˆ¶</h3>
                        
                        <div class="space-y-2">
                            <button id="quantumSplit" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 px-4 py-2 rounded-lg font-semibold transition-all duration-300">
                                ğŸŒ€ é‡å­åˆ†è£‚
                            </button>
                            <button id="quantumMerge" class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 px-4 py-2 rounded-lg font-semibold transition-all duration-300">
                                ğŸ”„ é‡å­åˆå¹¶
                            </button>
                            <button id="measurePiece" class="w-full bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700 px-4 py-2 rounded-lg font-semibold transition-all duration-300">
                                ğŸ“ é‡å­æµ‹é‡
                            </button>
                            <button id="createEntanglement" class="w-full bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 px-4 py-2 rounded-lg font-semibold transition-all duration-300">
                                ğŸŒ åˆ›å»ºçº ç¼ 
                            </button>
                        </div>
                    </div>

                    <!-- æ¸¸æˆçŠ¶æ€ -->
                    <div class="bg-black/30 rounded-lg p-6 border border-green-500/30 mt-6">
                        <h3 class="text-xl font-semibold mb-4 text-green-300">ğŸ“Š æ¸¸æˆçŠ¶æ€</h3>
                        
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span>å½“å‰å›åˆ:</span>
                                <span id="currentPlayer" class="font-semibold text-red-400">çº¢æ–¹</span>
                            </div>
                            <div class="flex justify-between">
                                <span>ç§»åŠ¨æ¬¡æ•°:</span>
                                <span id="moveCount" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>é‡å­æ€æ•°:</span>
                                <span id="quantumStates" class="font-semibold text-purple-400">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>çº ç¼ å¯¹æ•°:</span>
                                <span id="entanglementPairs" class="font-semibold text-blue-400">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ£‹ç›˜åŒºåŸŸ -->
                <div class="lg:col-span-2">
                    <div class="bg-black/30 rounded-lg p-6 border border-yellow-500/30">
                        <h3 class="text-xl font-semibold mb-4 text-yellow-300 text-center">ğŸ é‡å­è±¡æ£‹æ£‹ç›˜</h3>
                        
                        <!-- ç©å®¶ä¿¡æ¯ -->
                        <div class="flex justify-between mb-6">
                            <div class="bg-red-900/30 rounded-lg p-4 border border-red-500/50">
                                <div class="text-center">
                                    <div class="text-lg font-semibold text-red-300">çº¢æ–¹ (ä¸‹)</div>
                                    <div id="redPlayerStatus" class="text-sm text-gray-300">ç­‰å¾…å¼€å§‹</div>
                                </div>
                            </div>
                            <div class="bg-gray-900/30 rounded-lg p-4 border border-gray-500/50">
                                <div class="text-center">
                                    <div class="text-lg font-semibold text-gray-300">é»‘æ–¹ (ä¸Š)</div>
                                    <div id="blackPlayerStatus" class="text-sm text-gray-300">ç­‰å¾…å¼€å§‹</div>
                                </div>
                            </div>
                        </div>

                        <!-- è±¡æ£‹æ£‹ç›˜ -->
                        <div class="chess-board-container">
                            <div id="chessBoard" class="chess-board mx-auto">
                                <!-- æ£‹ç›˜å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>

                        <!-- æ¸¸æˆæ§åˆ¶æŒ‰é’® -->
                        <div class="flex justify-center space-x-4 mt-6">
                            <button id="undoMove" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded-lg font-semibold transition-all duration-300">
                                â†¶ æ‚”æ£‹
                            </button>
                            <button id="hintMove" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-semibold transition-all duration-300">
                                ğŸ’¡ æç¤º
                            </button>
                            <button id="pauseGame" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg font-semibold transition-all duration-300">
                                â¸ï¸ æš‚åœ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¸¸æˆæ—¥å¿—å’Œåæ€ -->
            <div class="grid md:grid-cols-2 gap-8 mt-8">
                <!-- æ¸¸æˆæ—¥å¿— -->
                <div class="bg-black/30 rounded-lg p-6 border border-cyan-500/30">
                    <h3 class="text-xl font-semibold mb-4 text-cyan-300">ğŸ“ æ¸¸æˆæ—¥å¿—</h3>
                    <div id="gameLog" class="h-64 overflow-y-auto bg-gray-900/50 rounded-lg p-4 text-sm space-y-2">
                        <div class="text-gray-400">æ¸¸æˆæ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</div>
                    </div>
                </div>

                <!-- é‡å­åæ€ -->
                <div class="bg-black/30 rounded-lg p-6 border border-purple-500/30">
                    <h3 class="text-xl font-semibold mb-4 text-purple-300">ğŸ§˜ é‡å­åæ€</h3>
                    <div id="quantumReflection" class="h-64 overflow-y-auto bg-gray-900/50 rounded-lg p-4 text-sm">
                        <div class="space-y-3">
                            <p class="text-gray-300">åœ¨é‡å­è±¡æ£‹ä¸­è§‚å¯Ÿä½ çš„æ€ç»´æ¨¡å¼ï¼š</p>
                            <ul class="space-y-2 text-gray-400">
                                <li>â€¢ ä½ å¦‚ä½•å¤„ç†ä¸ç¡®å®šæ€§å’Œå åŠ æ€ï¼Ÿ</li>
                                <li>â€¢ é¢å¯¹é‡å­çº ç¼ æ—¶çš„ç­–ç•¥é€‰æ‹©ï¼Ÿ</li>
                                <li>â€¢ åˆ†è£‚ç§»åŠ¨åæ˜ äº†ä»€ä¹ˆå¿ƒç†çŠ¶æ€ï¼Ÿ</li>
                                <li>â€¢ æµ‹é‡æ—¶æœºçš„æŠŠæ¡ä½“ç°äº†ä»€ä¹ˆæ™ºæ…§ï¼Ÿ</li>
                                <li>â€¢ åœ¨å¤šé‡å¯èƒ½æ€§ä¸­å¦‚ä½•åšå‡ºå†³ç­–ï¼Ÿ</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* è±¡æ£‹æ£‹ç›˜æ ·å¼ */
.chess-board {
    width: 100%;
    max-width: 500px;
    aspect-ratio: 9/10;
    background: linear-gradient(45deg, #8B4513, #D2691E);
    border: 3px solid #654321;
    border-radius: 10px;
    display: grid;
    grid-template-columns: repeat(9, 1fr);
    grid-template-rows: repeat(10, 1fr);
    gap: 1px;
    padding: 10px;
    position: relative;
}

.chess-square {
    background: #FAEBD7;
    border: 1px solid #D2691E;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.chess-square:hover {
    background: rgba(255, 215, 0, 0.3);
    transform: scale(1.05);
}

.chess-square.selected {
    background: rgba(0, 255, 0, 0.4) !important;
    box-shadow: 0 0 15px rgba(0, 255, 0, 0.6);
    border: 2px solid #00ff00;
}

.chess-square.possible-move {
    background: rgba(255, 255, 0, 0.4) !important;
    border: 2px dashed #ffff00;
}

.chess-square.superposition {
    background: linear-gradient(45deg, rgba(0, 255, 0, 0.3), rgba(0, 255, 255, 0.3)) !important;
    animation: quantumPulse 2s infinite;
}

.chess-square.entangled {
    background: linear-gradient(45deg, rgba(255, 0, 255, 0.3), rgba(255, 100, 255, 0.3)) !important;
    animation: entanglementGlow 1.5s infinite alternate;
}

.chess-piece {
    font-size: 1.5rem;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    transition: all 0.3s ease;
    z-index: 10;
}

.red-piece {
    color: #DC143C;
}

.black-piece {
    color: #2F4F4F;
}

.quantum-piece {
    position: relative;
    animation: quantumFlicker 3s infinite;
}

.quantum-piece::after {
    content: 'âš›ï¸';
    position: absolute;
    top: -8px;
    right: -8px;
    font-size: 0.6em;
    opacity: 0.8;
    animation: spin 2s linear infinite;
}

/* åŠ¨ç”»æ•ˆæœ */
@keyframes quantumPulse {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 1; }
}

@keyframes entanglementGlow {
    0% { box-shadow: 0 0 10px rgba(255, 0, 255, 0.5); }
    100% { box-shadow: 0 0 20px rgba(255, 0, 255, 0.8); }
}

@keyframes quantumFlicker {
    0%, 100% { opacity: 1; }
    25% { opacity: 0.7; }
    50% { opacity: 0.9; }
    75% { opacity: 0.8; }
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* æ¥šæ²³æ±‰ç•Œ */
.chess-board::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 10px;
    right: 10px;
    height: 2px;
    background: linear-gradient(90deg, transparent, #654321, transparent);
    transform: translateY(-50%);
    z-index: 5;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .chess-board {
        max-width: 350px;
    }
    
    .chess-piece {
        font-size: 1.2rem;
    }
}
</style>

<script>
// é‡å­è±¡æ£‹æ¸¸æˆé€»è¾‘
class QuantumChess {
    constructor() {
        this.board = null;
        this.selectedSquare = null;
        this.currentPlayer = 'red';
        this.gameMode = 'self';
        this.quantumMode = true;
        this.gameStarted = false;
        this.moveHistory = [];
        this.superpositionPieces = new Map();
        this.entangledPairs = new Map();
        this.nextPieceId = 1;
        
        this.initializeGame();
        this.bindEvents();
    }
    
    initializeGame() {
        this.createBoard();
        this.setupInitialPosition();
        this.updateGameStatus();
    }
    
    createBoard() {
        const board = document.getElementById('chessBoard');
        board.innerHTML = '';
        
        for (let row = 0; row < 10; row++) {
            for (let col = 0; col < 9; col++) {
                const square = document.createElement('div');
                square.className = 'chess-square';
                square.dataset.row = row;
                square.dataset.col = col;
                square.addEventListener('click', (e) => this.handleSquareClick(e));
                board.appendChild(square);
            }
        }
    }
    
    setupInitialPosition() {
        const initialBoard = [
            ['è»Š','é¦¬','è±¡','å£«','å°‡','å£«','è±¡','é¦¬','è»Š'],
            ['','','','','','','','',''],
            ['','ç ²','','','','','','ç ²',''],
            ['å’','','å’','','å’','','å’','','å’'],
            ['','','','','','','','',''],
            ['','','','','','','','',''],
            ['å…µ','','å…µ','','å…µ','','å…µ','','å…µ'],
            ['','ç‚®','','','','','','ç‚®',''],
            ['','','','','','','','',''],
            ['ä¿¥','å‚Œ','ç›¸','ä»•','å¸¥','ä»•','ç›¸','å‚Œ','ä¿¥']
        ];
        
        this.board = initialBoard;
        
        for (let row = 0; row < 10; row++) {
            for (let col = 0; col < 9; col++) {
                const square = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                const piece = initialBoard[row][col];
                if (piece) {
                    const pieceElement = document.createElement('span');
                    pieceElement.className = 'chess-piece';
                    pieceElement.textContent = piece;
                    
                    if (row <= 4) {
                        pieceElement.classList.add('black-piece');
                        pieceElement.dataset.color = 'black';
                    } else {
                        pieceElement.classList.add('red-piece');
                        pieceElement.dataset.color = 'red';
                    }
                    
                    square.appendChild(pieceElement);
                }
            }
        }
    }
    
    bindEvents() {
        document.getElementById('startGame').addEventListener('click', () => this.startGame());
        document.getElementById('resetGame').addEventListener('click', () => this.resetGame());
        document.getElementById('quantumSplit').addEventListener('click', () => this.enableQuantumSplit());
        document.getElementById('quantumMerge').addEventListener('click', () => this.enableQuantumMerge());
        document.getElementById('measurePiece').addEventListener('click', () => this.enableMeasurement());
        document.getElementById('createEntanglement').addEventListener('click', () => this.enableEntanglement());
        document.getElementById('undoMove').addEventListener('click', () => this.undoMove());
        document.getElementById('hintMove').addEventListener('click', () => this.showHint());
        document.getElementById('pauseGame').addEventListener('click', () => this.pauseGame());
    }
    
    handleSquareClick(event) {
        const square = event.currentTarget;
        const piece = square.querySelector('.chess-piece');
        
        if (!this.gameStarted) {
            this.addLog('è¯·å…ˆå¼€å§‹æ¸¸æˆ');
            return;
        }
        
        // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
        document.querySelectorAll('.chess-square.selected').forEach(sq => {
            sq.classList.remove('selected');
        });
        document.querySelectorAll('.chess-square.possible-move').forEach(sq => {
            sq.classList.remove('possible-move');
        });
        
        if (this.selectedSquare) {
            if (this.selectedSquare === square) {
                this.selectedSquare = null;
                return;
            }
            
            if (this.isValidMove(this.selectedSquare, square)) {
                this.movePiece(this.selectedSquare, square);
                this.selectedSquare = null;
                this.switchPlayer();
            } else {
                this.selectedSquare = null;
            }
        } else if (piece && piece.dataset.color === this.currentPlayer) {
            this.selectedSquare = square;
            square.classList.add('selected');
            this.showPossibleMoves(square);
        }
    }
    
    isValidMove(fromSquare, toSquare) {
        const fromRow = parseInt(fromSquare.dataset.row);
        const fromCol = parseInt(fromSquare.dataset.col);
        const toRow = parseInt(toSquare.dataset.row);
        const toCol = parseInt(toSquare.dataset.col);
        
        if (fromRow === toRow && fromCol === toCol) return false;
        
        const targetPiece = toSquare.querySelector('.chess-piece');
        const movingPiece = fromSquare.querySelector('.chess-piece');
        if (targetPiece && targetPiece.dataset.color === movingPiece.dataset.color) {
            return false;
        }
        
        if (toRow < 0 || toRow >= 10 || toCol < 0 || toCol >= 9) return false;
        
        return true;
    }
    
    showPossibleMoves(square) {
        const row = parseInt(square.dataset.row);
        const col = parseInt(square.dataset.col);
        
        const directions = [
            [-1, 0], [1, 0], [0, -1], [0, 1],
            [-1, -1], [-1, 1], [1, -1], [1, 1]
        ];
        
        directions.forEach(([dr, dc]) => {
            const newRow = row + dr;
            const newCol = col + dc;
            if (newRow >= 0 && newRow < 10 && newCol >= 0 && newCol < 9) {
                const targetSquare = document.querySelector(`[data-row="${newRow}"][data-col="${newCol}"]`);
                if (targetSquare && this.isValidMove(square, targetSquare)) {
                    targetSquare.classList.add('possible-move');
                }
            }
        });
    }
    
    movePiece(fromSquare, toSquare) {
        const piece = fromSquare.querySelector('.chess-piece');
        if (piece) {
            const move = {
                from: { row: fromSquare.dataset.row, col: fromSquare.dataset.col },
                to: { row: toSquare.dataset.row, col: toSquare.dataset.col },
                piece: piece.textContent,
                captured: null
            };
            
            const targetPiece = toSquare.querySelector('.chess-piece');
            if (targetPiece) {
                move.captured = targetPiece.textContent;
                targetPiece.remove();
            }
            
            toSquare.appendChild(piece);
            this.moveHistory.push(move);
            
            this.addLog(`${move.piece} ä» (${move.from.row}, ${move.from.col}) ç§»åŠ¨åˆ° (${move.to.row}, ${move.to.col})`);
            this.addReflection(`ç§»åŠ¨ ${move.piece}ï¼šè§‚å¯Ÿä½ çš„å†³ç­–è¿‡ç¨‹å’Œç›´è§‰`);
            
            this.updateMoveCount();
        }
    }
    
    switchPlayer() {
        this.currentPlayer = this.currentPlayer === 'red' ? 'black' : 'red';
        this.updateGameStatus();
    }
    
    startGame() {
        this.gameStarted = true;
        this.gameMode = document.getElementById('gameMode').value;
        this.quantumMode = document.getElementById('quantumMode').checked;
        
        document.getElementById('redPlayerStatus').textContent = 'æ€è€ƒä¸­...';
        document.getElementById('blackPlayerStatus').textContent = 'ç­‰å¾…ä¸­';
        
        this.addLog('æ¸¸æˆå¼€å§‹ï¼');
        this.addReflection('æ¸¸æˆå¼€å§‹ï¼šè§‚å¯Ÿä½ çš„å¼€å±€æ€è·¯å’Œå¿ƒç†çŠ¶æ€');
    }
    
    resetGame() {
        this.gameStarted = false;
        this.currentPlayer = 'red';
        this.moveHistory = [];
        this.superpositionPieces.clear();
        this.entangledPairs.clear();
        this.selectedSquare = null;
        
        document.getElementById('gameLog').innerHTML = '<div class="text-gray-400">æ¸¸æˆæ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</div>';
        document.getElementById('quantumReflection').innerHTML = `
            <div class="space-y-3">
                <p class="text-gray-300">åœ¨é‡å­è±¡æ£‹ä¸­è§‚å¯Ÿä½ çš„æ€ç»´æ¨¡å¼ï¼š</p>
                <ul class="space-y-2 text-gray-400">
                    <li>â€¢ ä½ å¦‚ä½•å¤„ç†ä¸ç¡®å®šæ€§å’Œå åŠ æ€ï¼Ÿ</li>
                    <li>â€¢ é¢å¯¹é‡å­çº ç¼ æ—¶çš„ç­–ç•¥é€‰æ‹©ï¼Ÿ</li>
                    <li>â€¢ åˆ†è£‚ç§»åŠ¨åæ˜ äº†ä»€ä¹ˆå¿ƒç†çŠ¶æ€ï¼Ÿ</li>
                    <li>â€¢ æµ‹é‡æ—¶æœºçš„æŠŠæ¡ä½“ç°äº†ä»€ä¹ˆæ™ºæ…§ï¼Ÿ</li>
                    <li>â€¢ åœ¨å¤šé‡å¯èƒ½æ€§ä¸­å¦‚ä½•åšå‡ºå†³ç­–ï¼Ÿ</li>
                </ul>
            </div>
        `;
        
        this.setupInitialPosition();
        this.updateGameStatus();
        this.updateMoveCount();
        this.updateQuantumStats();
        
        document.getElementById('redPlayerStatus').textContent = 'ç­‰å¾…å¼€å§‹';
        document.getElementById('blackPlayerStatus').textContent = 'ç­‰å¾…å¼€å§‹';
    }
    
    enableQuantumSplit() {
        if (!this.gameStarted || !this.quantumMode) {
            this.addLog('è¯·å…ˆå¼€å§‹é‡å­æ¨¡å¼æ¸¸æˆ');
            return;
        }
        this.addLog('é‡å­åˆ†è£‚æ¨¡å¼å·²å¯ç”¨ - é€‰æ‹©æ£‹å­è¿›è¡Œåˆ†è£‚');
        this.addReflection('å¯ç”¨é‡å­åˆ†è£‚ï¼šä½“éªŒä¸€å¿ƒå¤šç”¨çš„é‡å­æ€ç»´');
    }
    
    enableQuantumMerge() {
        if (!this.gameStarted || !this.quantumMode) {
            this.addLog('è¯·å…ˆå¼€å§‹é‡å­æ¨¡å¼æ¸¸æˆ');
            return;
        }
        this.addLog('é‡å­åˆå¹¶æ¨¡å¼å·²å¯ç”¨ - é€‰æ‹©å åŠ æ€æ£‹å­è¿›è¡Œåˆå¹¶');
        this.addReflection('å¯ç”¨é‡å­åˆå¹¶ï¼šè§‚å¯Ÿé€‰æ‹©å¦‚ä½•å¡Œç¼©å¯èƒ½æ€§');
    }
    
    enableMeasurement() {
        if (!this.gameStarted || !this.quantumMode) {
            this.addLog('è¯·å…ˆå¼€å§‹é‡å­æ¨¡å¼æ¸¸æˆ');
            return;
        }
        this.addLog('é‡å­æµ‹é‡æ¨¡å¼å·²å¯ç”¨ - è§‚å¯Ÿå³æ”¹å˜');
        this.addReflection('å¯ç”¨é‡å­æµ‹é‡ï¼šæ„è¯†çš„åŠ›é‡å¦‚ä½•å½±å“ç°å®');
    }
    
    enableEntanglement() {
        if (!this.gameStarted || !this.quantumMode) {
            this.addLog('è¯·å…ˆå¼€å§‹é‡å­æ¨¡å¼æ¸¸æˆ');
            return;
        }
        this.addLog('é‡å­çº ç¼ æ¨¡å¼å·²å¯ç”¨ - åˆ›å»ºæ£‹å­é—´çš„ç¥ç§˜å…³è”');
        this.addReflection('å¯ç”¨é‡å­çº ç¼ ï¼šæ„Ÿå—ä¸‡ç‰©ç›¸è¿çš„å®‡å®™æ³•åˆ™');
    }
    
    undoMove() {
        if (this.moveHistory.length === 0) {
            this.addLog('æ²¡æœ‰å¯ä»¥æ’¤é”€çš„ç§»åŠ¨');
            return;
        }
        
        const lastMove = this.moveHistory.pop();
        // å®ç°æ’¤é”€é€»è¾‘
        this.addLog('å·²æ’¤é”€ä¸Šä¸€æ­¥ç§»åŠ¨');
        this.addReflection('æ’¤é”€ç§»åŠ¨ï¼šåæ€å†³ç­–çš„å¯é€†æ€§ä¸åæ‚”å¿ƒç†');
    }
    
    showHint() {
        this.addLog('ğŸ’¡ æç¤ºï¼šè§‚å¯Ÿæ£‹å±€çš„æ•´ä½“æ€åŠ¿ï¼Œå¯»æ‰¾æœ€ä½³ç§»åŠ¨');
        this.addReflection('å¯»æ±‚æç¤ºï¼šä¾èµ–å¤–éƒ¨æŒ‡å¯¼è¿˜æ˜¯ç›¸ä¿¡å†…åœ¨æ™ºæ…§ï¼Ÿ');
    }
    
    pauseGame() {
        this.addLog('æ¸¸æˆå·²æš‚åœ');
        this.addReflection('æš‚åœæ¸¸æˆï¼šåœ¨é™æ­¢ä¸­è§‚å¯Ÿå†…å¿ƒçš„æ³¢åŠ¨');
    }
    
    updateGameStatus() {
        document.getElementById('currentPlayer').textContent = this.currentPlayer === 'red' ? 'çº¢æ–¹' : 'é»‘æ–¹';
        document.getElementById('currentPlayer').className = this.currentPlayer === 'red' ? 'font-semibold text-red-400' : 'font-semibold text-gray-400';
    }
    
    updateMoveCount() {
        document.getElementById('moveCount').textContent = this.moveHistory.length;
    }
    
    updateQuantumStats() {
        document.getElementById('quantumStates').textContent = this.superpositionPieces.size;
        document.getElementById('entanglementPairs').textContent = this.entangledPairs.size;
    }
    
    addLog(message) {
        const log = document.getElementById('gameLog');
        const entry = document.createElement('div');
        entry.className = 'text-cyan-300';
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
    }
    
    addReflection(message) {
        const reflection = document.getElementById('quantumReflection');
        const entry = document.createElement('div');
        entry.className = 'text-purple-300 border-l-2 border-purple-500 pl-3 mb-2';
        entry.textContent = `ğŸ§˜ ${message}`;
        reflection.appendChild(entry);
        reflection.scrollTop = reflection.scrollHeight;
    }
}

// åˆå§‹åŒ–æ¸¸æˆ
document.addEventListener('DOMContentLoaded', () => {
    new QuantumChess();
});
</script>
{% endblock %}