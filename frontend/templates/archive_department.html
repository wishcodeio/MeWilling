<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>八部｜典藏司 - 古籍管理與學習卡片系統</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', '微軟雅黑', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e8e8e8;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* 返回按鈕樣式 */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            padding: 12px 20px;
            color: #e8e8e8;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 768px) {
            .back-button {
                padding: 10px 16px;
                font-size: 12px;
            }
        }

        /* 主容器 */
        .archive-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 80px 20px 20px;
        }

        /* 標題區域 */
        .archive-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .archive-title {
            font-size: 3rem;
            background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }

        .archive-subtitle {
            font-size: 1.2rem;
            color: #b8b8b8;
            margin-bottom: 30px;
        }

        /* 功能卡片網格 */
        .function-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .function-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .function-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 215, 0, 0.3);
        }

        .card-icon {
            font-size: 2.5rem;
            color: #ffd700;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.5rem;
            color: #ffd700;
            margin-bottom: 15px;
        }

        .card-description {
            color: #b8b8b8;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        /* 按鈕樣式 */
        .btn {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #1a1a2e;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e8e8e8;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* 輸入框樣式 */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: #ffd700;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #e8e8e8;
            font-size: 14px;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* 模態框樣式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            color: #ffd700;
            font-size: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: #e8e8e8;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }

        /* 統計卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            color: #ffd700;
            font-weight: bold;
        }

        .stat-label {
            color: #b8b8b8;
            margin-top: 5px;
        }

        /* 文件列表 */
        .file-list {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .file-meta {
            color: #b8b8b8;
            font-size: 0.9rem;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .archive-title {
                font-size: 2rem;
            }
            
            .function-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }

        /* 載入動畫 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-radius: 50%;
            border-top-color: #ffd700;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* JSON編輯器樣式 */
        .json-editor {
            background: #1e1e1e;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #e8e8e8;
            min-height: 300px;
            white-space: pre-wrap;
            overflow: auto;
        }
    </style>
</head>
<body>
    <!-- 返回按鈕 -->
    <a href="javascript:void(0)" class="back-button" onclick="goBack()">
        <i class="fas fa-arrow-left"></i>
        <span>返回</span>
    </a>

    <div class="archive-container">
        <!-- 標題區域 -->
        <div class="archive-header">
            <h1 class="archive-title">八部｜典藏司</h1>
            <p class="archive-subtitle">古籍保存 · 母典管理 · 學習卡片生成</p>
        </div>

        <!-- 統計信息 -->
        <div class="stats-grid" id="statsGrid">
            <!-- 統計卡片將通過JavaScript動態生成 -->
        </div>

        <!-- 功能卡片 -->
        <div class="function-grid">
            <!-- 古籍JSON生成 -->
            <div class="function-card">
                <div class="card-icon">
                    <i class="fas fa-scroll"></i>
                </div>
                <h3 class="card-title">古籍JSON生成</h3>
                <p class="card-description">
                    生成標準化的古籍JSON文件，支持自定義古籍數據和示例模板生成。
                </p>
                <button class="btn" onclick="openModal('generateJsonModal')">生成示例JSON</button>
                <button class="btn btn-secondary" onclick="openModal('customJsonModal')">自定義生成</button>
            </div>

            <!-- 學習卡片轉換 -->
            <div class="function-card">
                <div class="card-icon">
                    <i class="fas fa-cards-blank"></i>
                </div>
                <h3 class="card-title">學習卡片轉換</h3>
                <p class="card-description">
                    將古籍JSON文件轉換為互動式學習卡片，支持批量導入和智能分類。
                </p>
                <button class="btn" onclick="openModal('jsonToCardsModal')">JSON轉卡片</button>
                <button class="btn btn-secondary" onclick="viewLearningCards()">查看卡片</button>
            </div>

            <!-- 文件管理 -->
            <div class="function-card">
                <div class="card-icon">
                    <i class="fas fa-folder-open"></i>
                </div>
                <h3 class="card-title">文件管理</h3>
                <p class="card-description">
                    管理已生成的古籍JSON文件，支持下載、預覽和驗證功能。
                </p>
                <button class="btn" onclick="loadFileList()">文件列表</button>
                <button class="btn btn-secondary" onclick="openModal('validateJsonModal')">驗證JSON</button>
            </div>

            <!-- 模板工具 -->
            <div class="function-card">
                <div class="card-icon">
                    <i class="fas fa-tools"></i>
                </div>
                <h3 class="card-title">模板工具</h3>
                <p class="card-description">
                    提供古籍數據模板和格式指南，幫助用戶創建符合標準的古籍數據。
                </p>
                <button class="btn" onclick="exportTemplate()">導出模板</button>
                <button class="btn btn-secondary" onclick="showCategories()">分類指南</button>
            </div>
        </div>

        <!-- 文件列表區域 -->
        <div class="file-list" id="fileList" style="display: none;">
            <h3 style="color: #ffd700; margin-bottom: 20px;">古籍JSON文件</h3>
            <div id="fileListContent">
                <!-- 文件列表將通過JavaScript動態生成 -->
            </div>
        </div>
    </div>

    <!-- 生成示例JSON模態框 -->
    <div id="generateJsonModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">生成示例古籍JSON</h3>
                <button class="close-btn" onclick="closeModal('generateJsonModal')">&times;</button>
            </div>
            <p style="color: #b8b8b8; margin-bottom: 20px;">生成包含多個古籍示例的JSON文件，用於測試和學習。</p>
            <button class="btn" onclick="generateSampleJson()">開始生成</button>
            <div id="generateResult" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- 自定義JSON生成模態框 -->
    <div id="customJsonModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">自定義古籍JSON生成</h3>
                <button class="close-btn" onclick="closeModal('customJsonModal')">&times;</button>
            </div>
            <form id="customJsonForm">
                <div class="form-group">
                    <label class="form-label">古籍標題</label>
                    <input type="text" class="form-input" name="title" required>
                </div>
                <div class="form-group">
                    <label class="form-label">古籍內容</label>
                    <textarea class="form-textarea" name="content" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">分類</label>
                    <select class="form-select" name="category" id="categorySelect">
                        <!-- 選項將通過JavaScript動態生成 -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">朝代</label>
                    <select class="form-select" name="dynasty" id="dynastySelect">
                        <!-- 選項將通過JavaScript動態生成 -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">作者</label>
                    <input type="text" class="form-input" name="author">
                </div>
                <div class="form-group">
                    <label class="form-label">難度</label>
                    <select class="form-select" name="difficulty">
                        <option value="easy">簡單</option>
                        <option value="medium" selected>中等</option>
                        <option value="hard">困難</option>
                    </select>
                </div>
                <button type="submit" class="btn">生成JSON</button>
            </form>
            <div id="customResult" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- JSON轉卡片模態框 -->
    <div id="jsonToCardsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">JSON轉換為學習卡片</h3>
                <button class="close-btn" onclick="closeModal('jsonToCardsModal')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">選擇轉換方式</label>
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="showFileSelector()">選擇文件</button>
                    <button class="btn btn-secondary" onclick="showJsonInput()">直接輸入JSON</button>
                </div>
            </div>
            <div id="fileSelector" style="display: none;">
                <select class="form-select" id="jsonFileSelect">
                    <option value="">選擇JSON文件...</option>
                </select>
                <button class="btn" onclick="convertFileToCards()" style="margin-top: 10px;">轉換為卡片</button>
            </div>
            <div id="jsonInput" style="display: none;">
                <label class="form-label">JSON數據</label>
                <div class="json-editor" contenteditable="true" id="jsonEditor" placeholder="請輸入JSON數據..."></div>
                <button class="btn" onclick="convertJsonToCards()" style="margin-top: 10px;">轉換為卡片</button>
            </div>
            <div id="convertResult" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- JSON驗證模態框 -->
    <div id="validateJsonModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">JSON格式驗證</h3>
                <button class="close-btn" onclick="closeModal('validateJsonModal')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">JSON內容</label>
                <div class="json-editor" contenteditable="true" id="validateJsonEditor" placeholder="請輸入要驗證的JSON內容..."></div>
            </div>
            <button class="btn" onclick="validateJson()">驗證格式</button>
            <div id="validateResult" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        // 全局變量
        let categories = {};
        let dynasties = {};
        let fileList = [];

        // 初始化頁面
        document.addEventListener('DOMContentLoaded', function() {
            loadCategoriesAndDynasties();
            loadStatistics();
        });

        // 返回按鈕功能
        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = '/';
            }
        }

        // 模態框控制
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            if (modalId === 'jsonToCardsModal') {
                loadJsonFileList();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // 載入分類和朝代信息
        async function loadCategoriesAndDynasties() {
            try {
                const response = await fetch('/api/archive/categories');
                const data = await response.json();
                
                if (data.success) {
                    categories = data.categories;
                    dynasties = data.dynasties;
                    
                    // 填充選擇框
                    populateSelect('categorySelect', categories);
                    populateSelect('dynastySelect', dynasties);
                }
            } catch (error) {
                console.error('載入分類信息失敗:', error);
            }
        }

        // 填充選擇框
        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            select.innerHTML = '';
            for (const [key, value] of Object.entries(options)) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${key} - ${value.description || value}`;
                select.appendChild(option);
            }
        }

        // 載入統計信息
        async function loadStatistics() {
            try {
                const response = await fetch('/api/archive/ancient_texts_stats');
                const data = await response.json();
                
                if (data.success) {
                    displayStatistics(data.statistics);
                }
            } catch (error) {
                console.error('載入統計信息失敗:', error);
            }
        }

        // 顯示統計信息
        function displayStatistics(stats) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.learning_cards.total_cards || 0}</div>
                    <div class="stat-label">學習卡片</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.json_files.files_count || 0}</div>
                    <div class="stat-label">JSON文件</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.json_files.total_texts || 0}</div>
                    <div class="stat-label">古籍文本</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Object.keys(stats.categories_info || {}).length}</div>
                    <div class="stat-label">分類數量</div>
                </div>
            `;
        }

        // 生成示例JSON
        async function generateSampleJson() {
            const resultDiv = document.getElementById('generateResult');
            resultDiv.innerHTML = '<div class="loading"></div> 正在生成示例JSON...';
            
            try {
                const response = await fetch('/api/archive/generate_sample_json', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div style="color: #4CAF50; margin-bottom: 10px;">
                            <i class="fas fa-check-circle"></i> ${data.message}
                        </div>
                        <button class="btn btn-secondary" onclick="downloadFile('${data.download_url}')">下載文件</button>
                        <button class="btn btn-secondary" onclick="previewJson(${JSON.stringify(data.content).replace(/"/g, '&quot;')})">預覽內容</button>
                    `;
                    loadStatistics(); // 重新載入統計
                } else {
                    resultDiv.innerHTML = `<div style="color: #f44336;"><i class="fas fa-exclamation-circle"></i> ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div style="color: #f44336;"><i class="fas fa-exclamation-circle"></i> 生成失敗: ${error.message}</div>`;
            }
        }

        // 自定義JSON生成
        document.getElementById('customJsonForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const textData = {
                title: formData.get('title'),
                content: formData.get('content'),
                category: formData.get('category'),
                dynasty: formData.get('dynasty'),
                author: formData.get('author'),
                difficulty: formData.get('difficulty')
            };
            
            const resultDiv = document.getElementById('customResult');
            resultDiv.innerHTML = '<div class="loading"></div> 正在生成自定義JSON...';
            
            try {
                const response = await fetch('/api/archive/generate_custom_json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ texts: [textData] })
                });
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div style="color: #4CAF50; margin-bottom: 10px;">
                            <i class="fas fa-check-circle"></i> ${data.message}
                        </div>
                        <button class="btn btn-secondary" onclick="downloadFile('${data.download_url}')">下載文件</button>
                        <button class="btn btn-secondary" onclick="previewJson(${JSON.stringify(data.content).replace(/"/g, '&quot;')})">預覽內容</button>
                    `;
                    loadStatistics();
                    e.target.reset();
                } else {
                    resultDiv.innerHTML = `<div style="color: #f44336;"><i class="fas fa-exclamation-circle"></i> ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div style="color: #f44336;"><i class="fas fa-exclamation-circle"></i> 生成失敗: ${error.message}</div>`;
            }
        });

        // 載入JSON文件列表
        async function loadJsonFileList() {
            try {
                const response = await fetch('/api/archive/list_json_files');
                const data = await response.json();
                
                if (data.success) {
                    fileList = data.files;
                    const select = document.getElementById('jsonFileSelect');
                    select.innerHTML = '<option value="">選擇JSON文件...</option>';
                    
                    data.files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.filename;
                        option.textContent = `${file.filename} (${(file.size / 1024).toFixed(1)}KB)`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('載入文件列表失敗:', error);
            }
        }

        // 顯示文件選擇器
        function showFileSelector() {
            document.getElementById('fileSelector').style.display = 'block';
            document.getElementById('jsonInput').style.display = 'none';
        }

        // 顯示JSON輸入
        function showJsonInput() {
            document.getElementById('fileSelector').style.display = 'none';
            document.getElementById('jsonInput').style.display = 'block';
        }

        // 從文件轉換為卡片
        async function convertFileToCards() {
            const filename = document.getElementById('jsonFileSelect').value;
            if (!filename) {
                alert('請選擇一個JSON文件');
                return;
            }
            
            const resultDiv = document.getElementById('convertResult');
            resultDiv.innerHTML = '<div class="loading"></div> 正在轉換為學習卡片...';
            
            try {
                const response = await fetch('/api/archive/json_to_cards', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ file_path: `data/ancient_texts/${filename}` })
                });
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div style="color: #4CAF50; margin-bottom: 10px;">
                            <i class="fas fa-check-circle"></i> ${data.message}
                        </div>
                        <button class="btn btn-secondary" onclick="viewLearningCards()">查看學習卡片</button>
                    `;
                    loadStatistics();
                } else {
                    resultDiv.innerHTML = `<div style="color: #f44336;"><i class="fas fa-exclamation-circle"></i> ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div style="color: #f44336;"><i class="fas fa-exclamation-circle"></i> 轉換失敗: ${error.message}</div>`;
            }
        }

        // 從JSON數據轉換為卡片
        async function convertJsonToCards() {
            const jsonEditor = document.getElementById('jsonEditor');
            const jsonText = jsonEditor.textContent.trim();
            
            if (!jsonText) {
                alert('請輸入JSON數據');
                return;
            }
            
            let jsonData;
            try {
                jsonData = JSON.parse(jsonText);
            } catch (error) {
                alert('JSON格式錯誤，請檢查語法');
                return;
            }
            
            const resultDiv = document.getElementById('convertResult');
            resultDiv.innerHTML = '<div class="loading"></div> 正在轉換為學習卡片...';
            
            try {
                const response = await fetch('/api/archive/json_to_cards', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ json_data: jsonData })
                });
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div style="color: #4CAF50; margin-bottom: 10px;">
                            <i class="fas fa-check-circle"></i> ${data.message}
                        </div>
                        <button class="btn btn-secondary" onclick="viewLearningCards()">查看學習卡片</button>
                    `;
                    loadStatistics();
                } else {
                    resultDiv.innerHTML = `<div style="color: #f44336;"><i class="fas fa-exclamation-circle"></i> ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div style="color: #f44336;"><i class="fas fa-exclamation-circle"></i> 轉換失敗: ${error.message}</div>`;
            }
        }

        // 驗證JSON格式
        async function validateJson() {
            const jsonEditor = document.getElementById('validateJsonEditor');
            const jsonText = jsonEditor.textContent.trim();
            
            if (!jsonText) {
                alert('請輸入JSON內容');
                return;
            }
            
            let jsonData;
            try {
                jsonData = JSON.parse(jsonText);
            } catch (error) {
                document.getElementById('validateResult').innerHTML = `
                    <div style="color: #f44336;">
                        <i class="fas fa-exclamation-circle"></i> JSON語法錯誤: ${error.message}
                    </div>
                `;
                return;
            }
            
            const resultDiv = document.getElementById('validateResult');
            resultDiv.innerHTML = '<div class="loading"></div> 正在驗證JSON格式...';
            
            try {
                const response = await fetch('/api/archive/validate_json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ json_content: jsonData })
                });
                const data = await response.json();
                
                if (data.success) {
                    const validation = data.validation;
                    let resultHtml = '';
                    
                    if (validation.is_valid) {
                        resultHtml += '<div style="color: #4CAF50;"><i class="fas fa-check-circle"></i> JSON格式驗證通過</div>';
                    } else {
                        resultHtml += '<div style="color: #f44336;"><i class="fas fa-exclamation-circle"></i> JSON格式驗證失敗</div>';
                    }
                    
                    if (validation.errors.length > 0) {
                        resultHtml += '<div style="margin-top: 10px;"><strong>錯誤:</strong><ul>';
                        validation.errors.forEach(error => {
                            resultHtml += `<li style="color: #f44336;">${error}</li>`;
                        });
                        resultHtml += '</ul></div>';
                    }
                    
                    if (validation.warnings.length > 0) {
                        resultHtml += '<div style="margin-top: 10px;"><strong>警告:</strong><ul>';
                        validation.warnings.forEach(warning => {
                            resultHtml += `<li style="color: #ff9800;">${warning}</li>`;
                        });
                        resultHtml += '</ul></div>';
                    }
                    
                    if (validation.suggestions.length > 0) {
                        resultHtml += '<div style="margin-top: 10px;"><strong>建議:</strong><ul>';
                        validation.suggestions.forEach(suggestion => {
                            resultHtml += `<li style="color: #2196F3;">${suggestion}</li>`;
                        });
                        resultHtml += '</ul></div>';
                    }
                    
                    resultDiv.innerHTML = resultHtml;
                } else {
                    resultDiv.innerHTML = `<div style="color: #f44336;"><i class="fas fa-exclamation-circle"></i> ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div style="color: #f44336;"><i class="fas fa-exclamation-circle"></i> 驗證失敗: ${error.message}</div>`;
            }
        }

        // 載入文件列表
        async function loadFileList() {
            const fileListDiv = document.getElementById('fileList');
            const contentDiv = document.getElementById('fileListContent');
            
            contentDiv.innerHTML = '<div class="loading"></div> 正在載入文件列表...';
            fileListDiv.style.display = 'block';
            
            try {
                const response = await fetch('/api/archive/list_json_files');
                const data = await response.json();
                
                if (data.success) {
                    if (data.files.length === 0) {
                        contentDiv.innerHTML = '<div style="color: #b8b8b8; text-align: center; padding: 20px;">暫無JSON文件</div>';
                        return;
                    }
                    
                    let html = '';
                    data.files.forEach(file => {
                        html += `
                            <div class="file-item">
                                <div class="file-info">
                                    <div class="file-name">${file.filename}</div>
                                    <div class="file-meta">
                                        大小: ${(file.size / 1024).toFixed(1)}KB | 
                                        創建: ${new Date(file.created_at).toLocaleString()}
                                    </div>
                                </div>
                                <div class="file-actions">
                                    <button class="btn btn-secondary" onclick="downloadFile('/api/archive/download_json/${file.filename}')">下載</button>
                                    <button class="btn btn-secondary" onclick="previewFile('${file.filename}')">預覽</button>
                                </div>
                            </div>
                        `;
                    });
                    contentDiv.innerHTML = html;
                } else {
                    contentDiv.innerHTML = `<div style="color: #f44336;"><i class="fas fa-exclamation-circle"></i> ${data.error}</div>`;
                }
            } catch (error) {
                contentDiv.innerHTML = `<div style="color: #f44336;"><i class="fas fa-exclamation-circle"></i> 載入失敗: ${error.message}</div>`;
            }
        }

        // 導出模板
        async function exportTemplate() {
            try {
                const response = await fetch('/api/archive/export_template');
                const data = await response.json();
                
                if (data.success) {
                    const blob = new Blob([JSON.stringify(data.template, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'ancient_text_template.json';
                    a.click();
                    URL.revokeObjectURL(url);
                } else {
                    alert('導出模板失敗: ' + data.error);
                }
            } catch (error) {
                alert('導出模板失敗: ' + error.message);
            }
        }

        // 顯示分類指南
        function showCategories() {
            let html = '<h4 style="color: #ffd700;">古籍分類指南</h4><ul style="color: #b8b8b8; line-height: 1.8;">';
            for (const [key, value] of Object.entries(categories)) {
                html += `<li><strong>${key}</strong>: ${value.description || value}</li>`;
            }
            html += '</ul>';
            
            html += '<h4 style="color: #ffd700; margin-top: 20px;">朝代信息</h4><ul style="color: #b8b8b8; line-height: 1.8;">';
            for (const [key, value] of Object.entries(dynasties)) {
                html += `<li><strong>${key}</strong>: ${value.period || value}</li>`;
            }
            html += '</ul>';
            
            // 創建臨時模態框顯示信息
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">分類與朝代指南</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    ${html}
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 查看學習卡片
        async function viewLearningCards() {
            try {
                // 先檢查是否有學習卡片
                const response = await fetch('/api/card_learning/cards');
                const data = await response.json();
                
                if (data.success && data.cards && data.cards.length > 0) {
                    // 有卡片，直接跳轉
                    window.location.href = '/card_learning';
                } else {
                    // 沒有卡片，提示用戶先轉換
                    alert('暫無學習卡片，請先將古籍JSON轉換為學習卡片。');
                }
            } catch (error) {
                console.error('檢查學習卡片失敗:', error);
                // 如果檢查失敗，直接跳轉讓用戶自己查看
                window.location.href = '/card_learning';
            }
        }

        // 下載文件
        function downloadFile(url) {
            const a = document.createElement('a');
            a.href = url;
            a.download = '';
            a.click();
        }

        // 預覽JSON內容
        function previewJson(content) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">JSON內容預覽</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="json-editor" style="max-height: 400px; overflow-y: auto;">${JSON.stringify(content, null, 2)}</div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 預覽文件
        async function previewFile(filename) {
            try {
                const response = await fetch(`/api/archive/download_json/${filename}`);
                const content = await response.json();
                previewJson(content);
            } catch (error) {
                alert('預覽文件失敗: ' + error.message);
            }
        }

        // 點擊模態框外部關閉
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>